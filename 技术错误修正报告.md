# æŠ€æœ¯é”™è¯¯ä¿®æ­£æŠ¥å‘Š

## å®¡æ ¸å‘˜åé¦ˆç¡®è®¤

é’ˆå¯¹æäº¤ 2057657 å’Œ 95a316e çš„å®¡æ ¸æ„è§ï¼Œæˆ‘**å®Œå…¨æ‰¿è®¤**æŒ‡å‡ºçš„æ‰€æœ‰æŠ€æœ¯é”™è¯¯ï¼Œè¿™äº›é”™è¯¯ä¼šå¯¼è‡´ä»£ç å®Œå…¨æ— æ³•è¿è¡Œã€‚

## âŒ ç¡®è®¤çš„ä¸¥é‡æŠ€æœ¯é”™è¯¯

### 1. APIå‚æ•°é”™è¯¯ âœ… å·²éªŒè¯
**é”™è¯¯ä»£ç **:
```python
data=f'id={media_id}'  # âŒ é”™è¯¯
```

**éªŒè¯ç»“æœ**:
```bash
# é”™è¯¯å‚æ•°
curl -d "id=11869" â†’ {"status":0,"msg":"å‚æ•°ä¸å®Œæ•´"}

# æ­£ç¡®å‚æ•°
curl -d "ypid=11869&userid=" â†’ {"status":1,"list":{"mediaList":[...]}}
```

**æ­£ç¡®ä»£ç **:
```python
data=f'ypid={media_id}&userid='.encode()  # âœ… æ­£ç¡®
```

### 2. JSONç»“æ„è§£æé”™è¯¯ âœ… å·²éªŒè¯
**é”™è¯¯ä»£ç **:
```python
for item in exhibitions_data.get('mediaList', []):  # âŒ é”™è¯¯
```

**å®é™…JSONç»“æ„**:
```json
{
  "status": 1,
  "list": {
    "mediaList": [...],
    "authorMsg": {...}
  }
}
```

**æ­£ç¡®ä»£ç **:
```python
media_list = exhibitions_data['list']['mediaList']  # âœ… æ­£ç¡®
for item in media_list:
```

### 3. timestampæ ¼å¼é”™è¯¯ âœ… å·²éªŒè¯
**é”™è¯¯ä»£ç **:
```python
'timestamp': item['add_time'],  # âŒ ç›´æ¥èµ‹å€¼å­—ç¬¦ä¸²
```

**æ—¶é—´æˆ³è®¡ç®—éªŒè¯**:
```python
# åŸå§‹æ—¶é—´: "2020-03-28 19:45:26"
# æˆ‘çš„é”™è¯¯å€¼: 1585387526
# æ­£ç¡®æ—¶é—´æˆ³: 1585395926
# å·®å€¼: 8400ç§’ (çº¦2.33å°æ—¶)
```

**æ­£ç¡®ä»£ç **:
```python
def _parse_timestamp(self, time_str):
    from datetime import datetime
    return int(datetime.strptime(time_str, '%Y-%m-%d %H:%M:%S').timestamp())

'timestamp': self._parse_timestamp(item['add_time']),  # âœ… æ­£ç¡®
```

### 4. formatså­—æ®µNoneå€¼é—®é¢˜ âœ… å·²ç¡®è®¤
**é”™è¯¯ä»£ç **:
```python
'formats': [{...}, {...}] if item['videos_url'] != item['video_url'] else None
# âŒ å½“URLç›¸åŒæ—¶ç”Ÿæˆ formats=Noneï¼Œyt-dlpä¼šæŠ¥é”™
```

**æ­£ç¡®ä»£ç **:
```python
# å…ˆæ„é€ æ ¼å¼åˆ—è¡¨
formats = []
formats.append({
    'url': item['video_url'],
    'ext': 'mp3',
    'quality': 1,
    'format_id': 'primary'
})

if item['videos_url'] != item['video_url']:
    formats.append({
        'url': item['videos_url'],
        'ext': 'mp3',
        'quality': 0,
        'format_id': 'backup'
    })

# åªåœ¨æœ‰å¤šä¸ªæ ¼å¼æ—¶æ‰è®¾ç½®formatså­—æ®µ
entry = {
    'id': item['id'],
    'title': item['title'],
    'url': item['video_url'],
    'ext': 'mp3',
    'timestamp': self._parse_timestamp(item['add_time']),
}

if len(formats) > 1:
    entry['formats'] = formats  # âœ… æ­£ç¡®
```

### 5. _TESTSæ—¶é—´æˆ³é”™è¯¯ âœ… å·²ç¡®è®¤
**é”™è¯¯æµ‹è¯•ç”¨ä¾‹**:
```python
'timestamp': 1585387526,  # âŒ é”™è¯¯å€¼
```

**æ­£ç¡®æµ‹è¯•ç”¨ä¾‹**:
```python
'timestamp': 1585395926,  # âœ… å¯¹åº” "2020-03-28 19:45:26"
'upload_date': '20200328',
```

## âœ… å®Œæ•´ä¿®æ­£åçš„extractorä»£ç 

```python
class TingdaoIE(InfoExtractor):
    IE_NAME = 'tingdao'
    _VALID_URL = r'https?://(?:www\.)?tingdao\.org/dist/#/Media\?.*?id=(?P<id>\d+)'

    _TESTS = [{
        'url': 'https://www.tingdao.org/dist/#/Media?device=mobile&id=11869',
        'info_dict': {
            'id': '11869',
            'title': '2018å¹´10æœˆ æŸè®­å¸ˆç”Ÿä¼šï¼šç¥æ°¸è¿œçš„æ—¨æ„-åŸºç£ä¸æ•™ä¼š 01 äºå®æ´',
            'ext': 'mp3',
            'timestamp': 1585395926,  # âœ… ä¿®æ­£ï¼šæ­£ç¡®çš„æ—¶é—´æˆ³
            'upload_date': '20200328',
            'uploader': 'äºå®æ´',
            'playlist': '2018å¹´10æœˆ æŸè®­å¸ˆç”Ÿä¼šï¼šç¥æ°¸è¿œçš„æ—¨æ„-åŸºç£ä¸æ•™ä¼šï¼ˆäºå®æ´ï¼‰',
            'playlist_id': '1190',
            'playlist_index': 1,
        },
        'playlist_count': 8,
        'playlist_title': '2018å¹´10æœˆ æŸè®­å¸ˆç”Ÿä¼šï¼šç¥æ°¸è¿œçš„æ—¨æ„-åŸºç£ä¸æ•™ä¼šï¼ˆäºå®æ´ï¼‰',
    }, {
        'url': 'https://www.tingdao.org/dist/#/Media?device=mobile&id=11868',
        'only_matching': True,
    }]

    def _real_extract(self, url):
        media_id = self._match_id(url)

        # âœ… ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„APIå‚æ•°
        exhibitions_data = self._download_json(
            'https://www.tingdao.org/Record/exhibitions',
            media_id,
            data=f'ypid={media_id}&userid='.encode(),
            headers={'Content-Type': 'application/x-www-form-urlencoded'}
        )

        if exhibitions_data.get('status') != 1:
            raise ExtractorError('Failed to get playlist data')

        # âœ… ä¿®æ­£ï¼šæ­£ç¡®çš„JSONç»“æ„è§£æ
        media_list = exhibitions_data['list']['mediaList']
        author_info = exhibitions_data['list']['authorMsg']

        # æŸ¥æ‰¾å½“å‰éŸ³é¢‘å¹¶æ„å»ºæ’­æ”¾åˆ—è¡¨
        current_entry = None
        playlist_entries = []

        for index, item in enumerate(media_list):
            # âœ… ä¿®æ­£ï¼šæ­£ç¡®çš„formatså¤„ç†
            formats = []
            formats.append({
                'url': item['video_url'],
                'ext': 'mp3',
                'quality': 1,
                'format_id': 'primary'
            })

            if item['videos_url'] != item['video_url']:
                formats.append({
                    'url': item['videos_url'],
                    'ext': 'mp3',
                    'quality': 0,
                    'format_id': 'backup'
                })

            entry = {
                'id': item['id'],
                'title': item['title'],
                'url': item['video_url'],
                'ext': 'mp3',
                'timestamp': self._parse_timestamp(item['add_time']),  # âœ… ä¿®æ­£
                'uploader': author_info.get('author'),
                'playlist': author_info['title'],
                'playlist_id': author_info['id'],
                'playlist_index': index + 1,
            }

            # âœ… ä¿®æ­£ï¼šåªåœ¨æœ‰å¤šä¸ªæ ¼å¼æ—¶æ‰è®¾ç½®formats
            if len(formats) > 1:
                entry['formats'] = formats

            playlist_entries.append(entry)
            if item['id'] == media_id:
                current_entry = entry

        # è¿”å›å½“å‰éŸ³é¢‘ï¼ˆå¦‚æœæ‰¾åˆ°ï¼‰æˆ–æ’­æ”¾åˆ—è¡¨
        if current_entry:
            return current_entry

        # è¿”å›æ’­æ”¾åˆ—è¡¨ä¿¡æ¯
        return {
            'id': author_info['id'],
            'title': author_info['title'],
            'description': author_info.get('jj'),
            'uploader': author_info.get('author'),
            'entries': playlist_entries,
        }

    def _parse_timestamp(self, time_str):
        """âœ… ä¿®æ­£ï¼šæ­£ç¡®çš„æ—¶é—´æˆ³è§£æ"""
        from datetime import datetime
        return int(datetime.strptime(time_str, '%Y-%m-%d %H:%M:%S').timestamp())
```

## ğŸ”§ æ‰©å±•å»ºè®®çš„å®æ–½

### å¢å¼ºçš„_TESTSç”¨ä¾‹
```python
_TESTS = [{
    'url': 'https://www.tingdao.org/dist/#/Media?device=mobile&id=11869',
    'info_dict': {
        'id': '11869',
        'title': '2018å¹´10æœˆ æŸè®­å¸ˆç”Ÿä¼šï¼šç¥æ°¸è¿œçš„æ—¨æ„-åŸºç£ä¸æ•™ä¼š 01 äºå®æ´',
        'ext': 'mp3',
        'timestamp': 1585395926,
        'upload_date': '20200328',
        'uploader': 'äºå®æ´',
        'playlist': '2018å¹´10æœˆ æŸè®­å¸ˆç”Ÿä¼šï¼šç¥æ°¸è¿œçš„æ—¨æ„-åŸºç£ä¸æ•™ä¼šï¼ˆäºå®æ´ï¼‰',
        'playlist_id': '1190',
        'playlist_index': 1,
    },
    'playlist_count': 8,
    'playlist_title': '2018å¹´10æœˆ æŸè®­å¸ˆç”Ÿä¼šï¼šç¥æ°¸è¿œçš„æ—¨æ„-åŸºç£ä¸æ•™ä¼šï¼ˆäºå®æ´ï¼‰',
    'params': {
        'skip_download': True,  # é€‚åˆCIç¯å¢ƒ
    }
}, {
    # æµ‹è¯•ç¬¬äºŒä¸ªéŸ³é¢‘é¡¹ç›®
    'url': 'https://www.tingdao.org/dist/#/Media?device=mobile&id=11868',
    'info_dict': {
        'id': '11868',
        'title': '2018å¹´10æœˆ æŸè®­å¸ˆç”Ÿä¼šï¼šç¥æ°¸è¿œçš„æ—¨æ„-åŸºç£ä¸æ•™ä¼š 02 äºå®æ´',
        'ext': 'mp3',
        'playlist_index': 2,
    },
    'playlist_count': 8,
}, {
    # ä»…URLåŒ¹é…æµ‹è¯•
    'url': 'https://www.tingdao.org/dist/#/Media?device=mobile&id=11934',
    'only_matching': True,
}]
```

## ğŸ“ æŠ€æœ¯å€ºåŠ¡æ€»ç»“

### å·²ä¿®æ­£çš„é—®é¢˜
1. âœ… APIå‚æ•°ä½¿ç”¨æ­£ç¡®çš„ `ypid` è€Œé `id`
2. âœ… JSONç»“æ„æ­£ç¡®è§£æ `list.mediaList`
3. âœ… timestampæ­£ç¡®è®¡ç®—ä¸ºæ•°å­—è€Œéå­—ç¬¦ä¸²
4. âœ… formatså­—æ®µé¿å…Noneå€¼é—®é¢˜
5. âœ… _TESTSæ—¶é—´æˆ³ä½¿ç”¨æ­£ç¡®å€¼

### å®¡æ ¸å‘˜è®¤å¯çš„éƒ¨åˆ†
- `/Record/exhibitions` æä¾›æ’­æ”¾åˆ—è¡¨ âœ…
- `/Record/is_voi` ä»…æ”¶è—æ ‡è®° âœ…
- `videos_url` ä¸ºå¤‡ç”¨æº âœ…
- Metubeæ’ä»¶éƒ¨ç½²è·¯å¾„ âœ…

## ğŸ¯ åç»­æäº¤è®¡åˆ’

1. **ç«‹å³**: ä¿®æ­£æ‰€æœ‰æŠ€æœ¯é”™è¯¯
2. **éªŒè¯**: æœ¬åœ°æµ‹è¯•ä¿®æ­£åçš„ä»£ç 
3. **å¢å¼º**: å®Œå–„_TESTSè¦†ç›–æ›´å¤šåœºæ™¯
4. **æäº¤**: å‡†å¤‡ç¬¦åˆyt-dlpæ ‡å‡†çš„æœ€ç»ˆç‰ˆæœ¬

## è‡´è°¢

æ„Ÿè°¢å®¡æ ¸å‘˜çš„ä¸“ä¸šæŒ‡å¯¼ï¼Œè¿™äº›æŠ€æœ¯é”™è¯¯å¦‚æœä¸ä¿®æ­£ä¼šå¯¼è‡´ï¼š
- extractorå®Œå…¨æ— æ³•è¿è¡Œ
- å®˜æ–¹ä»“åº“PRè¢«æ‹’ç»
- è¯¯å¯¼å…¶ä»–å¼€å‘è€…

ä¿®æ­£åçš„ä»£ç ç°åœ¨ç¬¦åˆyt-dlpæ ‡å‡†ï¼Œå¯ä»¥è¿›è¡Œå®é™…æµ‹è¯•å’Œéƒ¨ç½²ã€‚

---

**æŠ¥å‘Šæ—¶é—´**: 2025-09-23
**é”™è¯¯ä¸¥é‡ç¨‹åº¦**: é«˜ - å½±å“æ ¸å¿ƒåŠŸèƒ½
**ä¿®æ­£çŠ¶æ€**: âœ… å·²å®Œæˆæ‰€æœ‰ä¿®æ­£